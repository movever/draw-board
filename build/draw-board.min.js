define(function(){return function(a,b,c){var d=function(a,b,c){a.save(),a.beginPath(),a.moveTo(b.left,b.top),a.lineTo(c.left,c.top),a.fillStyle=a.strokeStyle;var d=Math.atan((c.top-b.top)/(c.left-b.left)),e=Math.PI/2+d;c.left<b.left&&(e-=Math.PI),a.translate(c.left,c.top),a.rotate(e);var f=30/180*Math.PI/2,g=15*Math.tan(f);a.moveTo(0,0),a.lineTo(g,15),a.lineTo(-g,15),a.stroke(),a.fill(),a.restore()};return{start:function(){},ing:function(a,c){b.clearRect(0,0,b.canvas.width,b.canvas.height),d(b,a,c)},end:function(e,f){b.clearRect(0,0,b.canvas.width,b.canvas.height);var g=c.color,h=function(){a.strokeStyle=g,d(a,e,f)};h(),c.stack.push(h),c.rstack=[]}}}}),define(function(){return function(a,b,c){var d=(a.canvas,b.canvas),e=[];return{start:function(a){b.beginPath(),b.lineJoin="round",b.moveTo(a.left,a.top),e.push(a)},ing:function(a,c){b.clearRect(0,0,d.width,d.height),b.lineTo(c.left,c.top),e.push(c),b.stroke()},end:function(){b.clearRect(0,0,d.width,d.height);var f=e.slice(0),g=a.strokeStyle,h=a.lineWidth,i=function(){a.save(),a.strokeStyle=g,a.lineWidth=h,a.beginPath(),$.each(f,function(b,c){0===b?a.moveTo(c.left,c.top):a.lineTo(c.left,c.top)}),a.stroke(),a.restore()};i(),c.stack.push(i),c.rstack=[],e=[]}}}}),define(["jquery","mouse"],function(a,b){var c=function(c,d){var e=a(c),f=d.dragging||a.noop,g=d.dragend||a.noop,h=d.dragcontinue||a.noop,i=d.dragpause||a.noop,j=d.dragstart||a.noop;e.each(function(){var c=a.proxy(function(a){return b(this,a)},this),d=a(this),e={down:!1};d.mousedown(function(a){return 1==e.down?!1:(e.down=!0,e.downOffset=c(a),j.call(this,e.downOffset),void 0)}),d.mouseup(function(a){e.down=!1,1==e.move&&(g.call(this,e.downOffset,c(a)),e.move=!1)}),d.mouseout(function(a){e.down&&(i.call(this,c(a)),e.out=!0)});var k=function(a){e.down&&(e.out===!0&&h.call(this,c(a)),e.out=!1,e.move=!0,f.call(this,e.downOffset,c(a)))};d.mousemove(k)})};return c}),define(function(a){var b=a("drag"),c=a("mouse"),d=a("arrow"),e=a("arrow"),f=a("round"),g=a("line"),h=a("curve"),i=a("ease"),j=(a("util"),a("html2canvas"),function(){return!1}),k=function(a){var j=this;this.option=a||{},this.type=a.type||"rect",this.lineWidth=a.lineWidth||1,this.color=a.color||"rgb(0, 0, 0)",this.stack=[],this.rstack=[];var k=this.canvas1=document.createElement("canvas"),l=this.$canvas1=$(k),m=this.canvas2=document.createElement("canvas"),n=this.$canvas2=$(m),o=l.add(n),p=$("<div></div>").append(l,n);p.css({width:a.width,height:a.height,position:"relative"}),k.width=m.width=a.width,k.height=m.height=a.height,o.css({position:"absolute",left:0,top:0}),p.appendTo(a.parent),window.G_vmlCanvasManager&&($("#btn_eraser").hide(),k=window.G_vmlCanvasManager.initElement(k),m=window.G_vmlCanvasManager.initElement(m));var q=this.ctx1=k.getContext("2d"),r=this.ctx2=m.getContext("2d"),a=a||{clearBt:null,saveBt:null};q.save(),r.strokeStyle=this.color,q.strokeStyle=this.color,r.lineWidth=this.lineWidth,q.lineWidth=this.lineWidth;var s={};$(m).mousemove(function(a){s=c($(m).get(0),a)});var t={};t.rect=e(q,r,j),t.round=f(q,r,j),t.line=g(q,r,j),t.ease=i(q,r,j),t.curve=h(q,r,j),q.canvas=k,r.canvas=m,t.arrow=d(q,r,j),b(m,{dragstart:function(a){j.refuseSelection(),(t[j.type].start||$.noop)(a)},dragcontinue:function(a){j.refuseSelection(),(t[j.type]["continue"]||$.noop)(a)},dragpause:function(a){j.allowSelection(),(t[j.type].pause||$.noop)(a)},dragging:function(a,b){t[j.type].ing(a,b)},dragend:function(a,b){t[j.type].end(a,b),j.allowSelection()}})};return k.prototype={back:function(){this.ctx1.clearRect(0,0,this.canvas1.width,this.canvas1.height);var a=this.stack.pop();a&&this.rstack.push(a),this.drawStack()},forward:function(){this.ctx1.clearRect(0,0,this.canvas1.width,this.canvas1.height);var a=this.rstack.pop();a&&this.stack.push(a),this.drawStack()},drawStack:function(){$.each(this.stack,function(){this&&this()})},setColor:function(a){this.color=this.ctx1.strokeStyle=this.ctx2.strokeStyle=a},setLineWidth:function(a){this.lineWidth=this.ctx1.lineWidth=this.ctx2.lineWidth=a},refuseSelection:function(){$("body").attr("unselectable","on").css({"-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","-o-user-select":"none","user-select":"none"}).bind("selectstart",j),this.clearSelection()},allowSelection:function(){$("body").attr("unselectable","off").css({"-webkit-user-select":"auto","-moz-user-select":"auto","-ms-user-select":"auto","-o-user-select":"auto","user-select":"auto"}).unbind("selectstart",j)},clearSelection:function(){document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges()},clear:function(){var a=this,b=this.canvas2,c=function(){a.ctx1.clearRect(0,0,b.width,b.height),a.rstack=[]};c(),this.stack.push(c)},save:function(a){if(!window.getComputedStyle)return void alert("您的浏览器不支持");html2canvas($(a)[0]||$(this.option.parent)[0],{onrendered:function(a){var b=a.toDataURL("image/jpeg"),c=window.open();$(c.document.body).append('<img src="'+b+'" />'),c.document.title="保存绘图"}})}},k}),define(function(){return function(a,b,c){var d=(a.canvas,b.canvas),e=[];return{ing:function(c,f){function g(){b.clearRect(0,0,d.width,d.height),b.beginPath(),b.arc(Math.floor(f.left),Math.floor(f.top),10,0,2*Math.PI),b.stroke()}(g=_.throttle(g,140))();var h=function(){a.globalCompositeOperation="destination-out",a.beginPath(),a.arc(Math.floor(f.left),Math.floor(f.top),10,0,2*Math.PI,!0),a.closePath(),a.fill(),a.globalCompositeOperation="source-over"};h(),e.push(h)},end:function(){c.ctx2.clearRect(0,0,c.canvas2.width,c.canvas2.height);var a=e.slice(0);c.stack.push(function(){$.each(a,function(){this()})}),c.rstack=[],c.easeFn=[]}}}}),define(function(){return function(a,b,c){var d=(a.canvas,b.canvas);return{ing:function(a,c){b.clearRect(0,0,d.width,d.height),b.beginPath(),b.moveTo(a.left,a.top),b.lineTo(c.left,c.top),b.stroke()},end:function(e,f){b.clearRect(0,0,d.width,d.height);var g=a.strokeStyle,h=a.lineWidth,i=function(){a.save(),a.strokeStyle=g,a.lineWidth=h,a.beginPath(),a.moveTo(e.left,e.top),a.lineTo(f.left,f.top),a.stroke(),a.restore()};i(),c.stack.push(i),c.rstack=[]}}}}),define(function(){var a=function(a){var b,c;for(b=0,c=0;;)if(b+=a.offsetLeft,c+=a.offsetTop,!(a=a.offsetParent))break;return{x:b,y:c}},b=function(b,c){var d=a(b);return{left:c.pageX-d.x,top:c.pageY-d.y}};return b}),define(function(){return function(a,b,c){var d=(a.canvas,b.canvas);return{ing:function(a,c){b.clearRect(0,0,d.width,d.height),b.strokeRect(a.left,a.top,c.left-a.left,c.top-a.top)},end:function(e,f){b.clearRect(0,0,d.width,d.height);var g=a.strokeStyle,h=a.lineWidth,i=function(){a.save(),a.lineWidth=h,a.strokeStyle=g,a.strokeRect(e.left,e.top,f.left-e.left,f.top-e.top),a.restore()};i(),c.stack.push(i),c.rstack=[]}}}}),define(["util"],function(a){var b=a.len;return function(a,c,d){var e=(a.canvas,c.canvas);return{ing:function(a,d){c.clearRect(0,0,e.width,e.height),c.beginPath(),c.arc(a.left+(d.left-a.left)/2,a.top+(d.top-a.top)/2,b(a,d)/2,0,2*Math.PI),c.stroke()},end:function(f,g){c.clearRect(0,0,e.width,e.height);var h=a.strokeStyle,i=a.lineWidth,j=function(){a.save(),a.lineWidth=i,a.strokeStyle=h,a.beginPath(),a.arc(f.left+(g.left-f.left)/2,f.top+(g.top-f.top)/2,b(f,g)/2,0,2*Math.PI),a.stroke(),a.restore()};j(),d.stack.push(j),d.rstack=[]}}}}),define(function(){var a=function(a,b){var c=b.left-a.left,d=b.top-a.top;return Math.sqrt(Math.pow(c,2)+Math.pow(d,2))};return{len:a}});